(()=>{const i={$refs:{},_nmFetching:!1,_nmAbort:null,$get(e,t){this.$fetch(e,"GET",t)},$post(e,t){this.$fetch(e,"POST",t)},$fetch(e,t,s){const r=n;this._nmAbort&&this._nmAbort.abort(),this._nmAbort=new AbortController,this._nmFetching=!0;const o={headers:{"nm-request":!0},method:t,signal:this._nmAbort.signal};s={...this.$nmData(),...this.$dataset(),...s};const i=new URLSearchParams(s);/GET|DELETE/.test(t)?e+=(e.includes("?")?"&":"?")+i:o.body=i,fetch(e,o).then(async e=>{if(!e.ok){const t=await e.text();throw new Error(`${e.statusText}: ${t}`)}const t=new TextDecoder;for await(const n of e.body){const s=t.decode(n,{stream:!0});l(s)}}).catch(t=>a(r,"error",{err:t,url:e})).finally(()=>this._nmFetching=!1)},$nmData(){const e=e=>/string|number|boolean/.test(typeof e);return Object.fromEntries(Object.entries(this).filter(([e])=>/^[a-z]+$/i.test(e)).map(([e,t])=>typeof t=="function"?[e,t()]:[e,t]).filter(([t,n])=>e(n)||Array.isArray(n)&&n.every(e)))},$dataset(){let t={},e=n;for(;e;){if(t={...t,...e.dataset},e.hasAttribute("nm-data"))break;e=e.parentElement}return t},$watch:o};let e=null,n=null;const a=(e,t,n,s=!0)=>{e.dispatchEvent(new CustomEvent(`nm${t}`,{detail:n,bubbles:s}))},l=e=>{const t=(new DOMParser).parseFromString(e,"text/html").body.children;for(let e of t){if(!e.id){console.warn(`[Nomini] Fragment is missing an id: ${e}`);continue}const n=e.getAttribute("nm-swap")||"outerHTML",s=document.getElementById(e.id);if(!s){console.warn(`[Nomini] Swap target with id "${e.id}" not found`);continue}if(d(e),n==="innerHTML")s.replaceChildren(...e.childNodes),e=s;else if(n==="outerHTML")s.replaceWith(e);else if(/(before|after)(begin|end)/.test(n))s.insertAdjacentElement(n,e);else{console.error(`[Nomini] Invalid swap strategy "${n}"`);continue}c(e)}},d=e=>{const n=["style","class","height","width"],s=t(e,"[id]");s.forEach(e=>{const t=document.getElementById(e.id);if(t&&t.tagName===e.tagName){const o=e.cloneNode(),s=t=>n.forEach(n=>{const s=t.getAttribute(n);s?e.setAttribute(n,s):e.removeAttribute(n)});s(t),requestAnimationFrame(()=>s(o))}})},r=(e,t,n)=>{/^{.*}$/s.test(e)&&(e=e.slice(1,-1));try{return new Function("__data",`with(__data) {return {${e}}}`).call(n,t)}catch(t){return console.error("[Nomini] failed to parse obj:",e,`
`,t),{}}},t=(e,t)=>{const n=e.matches(t)?[e]:[];return[...n,...e.querySelectorAll(t)].filter(e=>!e.closest("[nm-ignore]"))},s=e=>e.closest("[nm-data]")?.nmProxy||{...i},o=t=>{e=t,e(),e=null},c=c=>{t(c,"[nm-use]").forEach(e=>{const t=e.getAttribute("nm-use"),n=document.getElementById(t);if(n){const t=n.content.cloneNode(!0),s=t.querySelector("slot:not([name])");s&&s.replaceWith(...e.childNodes),e.replaceChildren(t)}else console.error(`[Nomini] no template with id "${t}"`)}),t(c,"[nm-data]").forEach(t=>{const s={...r(t.getAttribute("nm-data"),{},t),...i},n=Object.fromEntries(Object.keys(s).map(e=>[e,new Set])),o=new Proxy(s,{get(t,s){return s in n&&e&&n[s].add(e),t[s]},set(t,s,o){t[s]=o,s in n||(n[s]=new Set);const i=e;return e=null,n[s].forEach(e=>e()),e=i,!0}});t.nmProxy=o}),t(c,"[nm-ref]").forEach(e=>{const t=s(e),n=e.getAttribute("nm-ref");t.$refs[n]=e}),t(c,"[nm-form]").forEach(e=>{const n=s(e);t(e,"[name]").forEach(e=>{const t=()=>{let t;e.type==="checkbox"?t=e.checked:e.type==="radio"&&e.checked?t=e.value:e.type==="file"?t=e.files:/number|range/.test(e.type)?t=+e.value:t=e.value,n[e.name]=t};t(),e.addEventListener("input",t),e.addEventListener("change",t)}),t(e,"button, input[type='submit']").forEach(e=>{o(()=>e.disabled=n._nmFetching)})}),t(c,"nm-bind").forEach(e=>{const t=s(e),i=r(el.getAttribute(attr),t,el);Object.entries(i).forEach(([s,i])=>{if(i in t||(i=i.bind(e)),s.startsWith("on")){const[a,...t]=s.slice(2).split("."),r=t.find(e=>e.startsWith("debounce")),o=+r?.slice(8),c=s=>{const a=()=>{n=e,i(s),n=null};t.includes("prevent")&&s.preventDefault(),t.includes("stop")&&s.stopPropagation(),o?(clearTimeout(e.nmTimer),e.nmTimer=setTimeout(a,o)):a()};e.addEventListener(a,c,{once:t.includes("once")})}else n=e,o(async()=>{const t=await i(),[n,o]=s.split(".");o?n==="class"?e.classList.toggle(o,t):e[n][o]=t:e[n]=t}),n=null}),a(el,"init",{},!1)})};document.addEventListener("DOMContentLoaded",()=>c(document.body))})()