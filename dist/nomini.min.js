(()=>{const o=(e,t,n)=>{n={bubbles:!0,detail:{},...n},e.dispatchEvent(new CustomEvent(`nm${t}`,n))},r=(e,t,n)=>{/^{.*}$/s.test(e)&&(e=e.slice(1,-1));try{return new Function("__data",`with(__data) {return {${e}}}`).call(n,t)}catch(t){return console.error("[Nomini] failed to parse obj:",e,`
`,t),{}}},e=(e,t)=>{const n=e.matches(t)?[e]:[];return[...n,...e.querySelectorAll(t)].filter(e=>!e.closest("[nm-ignore]"))},i=e=>e.closest("[nm-data]")?.nmProxy||{...c},a=e=>{t=e,t(),t=null};let t=null,n=null;const c={$refs:{},_nmFetching:!1,_nmAbort:null,$get(e,t){this.$fetch(e,"GET",t)},$post(e,t){this.$fetch(e,"POST",t)},$fetch(e,t,s){const r=n;this._nmAbort&&this._nmAbort.abort(),this._nmAbort=new AbortController,this._nmFetching=!0;const i={headers:{"nm-request":!0},method:t,signal:this._nmAbort.signal};s={...this.$nmData(),...this.$dataset(),...s};const a=new URLSearchParams(s);/GET|DELETE/.test(t)?e+=(e.includes("?")?"&":"?")+a:i.body=a,fetch(e,i).then(async e=>{if(!e.ok){const t=await e.text();throw new Error(`${e.statusText}: ${t}`)}const t=new TextDecoder;for await(const n of e.body){const s=t.decode(n,{stream:!0});l(s)}}).catch(t=>o(r,"error",{detail:{err:t,url:e}})).finally(()=>this._nmFetching=!1)},$nmData(){const e=e=>/string|number|boolean/.test(typeof e);return Object.entries(this).reduce((t,[n,s])=>/^[a-z]+$/i.test(n)?(typeof s=="function"&&(s=s()),(e(s)||Array.isArray(s)&&s.every(e))&&(t[n]=s),t):t,{})},$dataset(){let t={},e=n;for(;e;){if(t={...t,...e.dataset},e.hasAttribute("nm-data"))break;e=e.parentElement}return t},$watch:a,$dispatch(e,t){n.dispatchEvent(new CustomEvent(e,{detail:t}))}},l=e=>{const t=(new DOMParser).parseFromString(e,"text/html").body.children;for(const e of t){if(!e.id){console.warn(`[Nomini] Fragment is missing an id: ${e}`);continue}const i=e.getAttribute("nm-swap")||"outerHTML",n=document.getElementById(e.id);if(!n){console.warn(`[Nomini] Swap target with id "${e.id}" not found`);continue}if(o(n,"destroy"),d(e),i==="inner")n.replaceChildren(...e.childNodes),s(n);else if(i==="outer")n.replaceWith(e),s(e);else if(/before|after|prepend|append/.test(i)){const t=[...e.childNodes];n[i](...t),t.forEach(e=>e.nodeType===1&&s(e))}else console.error(`[Nomini] Invalid swap strategy "${i}"`)}},d=t=>{const n=["style","class","height","width"],s=e(t,"[id]");s.forEach(e=>{const t=document.getElementById(e.id);if(t&&t.tagName===e.tagName){const o=e.cloneNode(),s=t=>n.forEach(n=>{const s=t.getAttribute(n);s?e.setAttribute(n,s):e.removeAttribute(n)});s(t),requestAnimationFrame(()=>s(o))}})},s=s=>{e(s,"[nm-use]").forEach(e=>{const t=e.getAttribute("nm-use"),n=document.getElementById(t);if(n){const t=n.content.cloneNode(!0),s=t.querySelector("slot:not([name])");s&&s.replaceWith(...e.childNodes),e.replaceChildren(t)}else console.error(`[Nomini] no template with id "${t}"`)}),e(s,"[nm-data]").forEach(e=>{const s={...r(e.getAttribute("nm-data"),{},e),...c},n=Object.fromEntries(Object.keys(s).map(e=>[e,new Set])),o=new Proxy(s,{get(e,s){return s in n&&t&&n[s].add(t),e[s]},set(e,s,o){e[s]=o,s in n||(n[s]=new Set);const i=t;return t=null,n[s].forEach(e=>e()),t=i,!0}});e.nmProxy=o}),e(s,"[nm-ref]").forEach(e=>{const t=i(e),n=e.getAttribute("nm-ref");t.$refs[n]=e}),e(s,"[nm-form]").forEach(t=>{const n=i(t);e(t,"[name]").forEach(e=>{const t=()=>{let t;e.type==="checkbox"?t=e.checked:e.type==="radio"&&e.checked?t=e.value:e.type==="file"?t=e.files:/number|range/.test(e.type)?t=+e.value:t=e.value,n[e.name]=t};t(),e.addEventListener("input",t),e.addEventListener("change",t)}),e(t,"button, input[type='submit']").forEach(e=>{a(()=>e.disabled=n._nmFetching)})}),e(s,"[nm-bind]").forEach(e=>{const t=i(e),s=r(e.getAttribute("nm-bind"),t,e);Object.entries(s).forEach(([t,s])=>{if(t.startsWith("on")){const[a,...o]=t.slice(2).split("."),r=o.find(e=>e.startsWith("debounce")),i=+r?.slice(8),c=t=>{const a=()=>{n=e,s(t),n=null};o.includes("prevent")&&t.preventDefault(),o.includes("stop")&&t.stopPropagation(),i?(clearTimeout(e.nmTimer),e.nmTimer=setTimeout(a,i)):a()};(o.includes("window")?window:e).addEventListener(a,c,{once:o.includes("once")})}else n=e,a(async()=>{const n=await s(),[o,i]=t.split(".");i?o==="class"?e.classList.toggle(i,n):e[o][i]=n:e[o]=n}),n=null}),o(e,"init",{bubbles:!1})})};document.addEventListener("DOMContentLoaded",()=>s(document.body))})()