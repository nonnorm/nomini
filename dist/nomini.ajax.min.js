(()=>{const s={$refs:{},_nmFetching:!1,_nmAbort:null,$get(e,t){this.$fetch(e,"GET",t)},$post(e,t){this.$fetch(e,"POST",t)},$fetch(e,n,s){const r=t;this._nmAbort&&this._nmAbort.abort(),this._nmAbort=new AbortController,this._nmFetching=!0;const i={headers:{"nm-request":!0},method:n,signal:this._nmAbort.signal};s={...this.$nmData(),...this.$dataset(),...s};const a=new URLSearchParams(s);/GET|DELETE/.test(n)?e+=(e.includes("?")?"&":"?")+a:i.body=a,fetch(e,i).then(async e=>{if(!e.ok){const t=await e.text();throw new Error(`${e.statusText}: ${t}`)}const t=new TextDecoder;for await(const n of e.body){const s=t.decode(n,{stream:!0});l(s)}}).catch(t=>o(r,"error",{err:t,url:e})).finally(()=>this._nmFetching=!1)},$nmData(){const e=e=>/string|number|boolean/.test(typeof e);return Object.fromEntries(Object.entries(this).filter(([e])=>/^[a-z]+$/i.test(e)).map(([e,t])=>typeof t=="function"?[e,t()]:[e,t]).filter(([t,n])=>e(n)||Array.isArray(n)&&n.every(e)))},$dataset(){let n={},e=t;for(;e;){if(n={...n,...e.dataset},e.hasAttribute("nm-data"))break;e=e.parentElement}return n},$watch:r};let e=null,t=null;const o=(e,t,n,s=!0)=>{e.dispatchEvent(new CustomEvent(`nm${t}`,{detail:n,bubbles:s}))},l=e=>{const t=(new DOMParser).parseFromString(e,"text/html").body.children;for(let e of t){if(!e.id){console.warn(`[Nomini] Fragment is missing an id: ${e}`);continue}const n=e.getAttribute("nm-swap")||"outerHTML",s=document.getElementById(e.id);if(!s){console.warn(`[Nomini] Swap target with id "${e.id}" not found`);continue}if(d(e),n==="innerHTML")s.replaceChildren(...e.childNodes),e=s;else if(n==="outerHTML")s.replaceWith(e);else if(/(before|after)(begin|end)/.test(n))s.insertAdjacentElement(n,e);else{console.error(`[Nomini] Invalid swap strategy "${n}"`);continue}c(e)}},d=e=>{const t=["style","class","height","width"],s=n(e,"[id]");s.forEach(e=>{const n=document.getElementById(e.id);if(n&&n.tagName===e.tagName){const o=e.cloneNode(),s=n=>t.forEach(t=>{const s=n.getAttribute(t);s?e.setAttribute(t,s):e.removeAttribute(t)});s(n),requestAnimationFrame(()=>s(o))}})},i=(e,t,n)=>{/^{.*}$/s.test(e)&&(e=e.slice(1,-1));try{return new Function("__data",`with(__data) {return {${e}}}`).call(n,t)}catch(t){return console.error("[Nomini] failed to parse obj:",e,`
`,t),{}}},n=(e,t)=>{const n=e.matches(t)?[e]:[];return[...n,...e.querySelectorAll(t)].filter(e=>!e.closest("[nm-ignore]"))},a=e=>e.closest("[nm-data]")?.nmProxy||{...s},r=t=>{e=t,e(),e=null},c=c=>{n(c,"[nm-data]").forEach(t=>{const o={...i(t.getAttribute("nm-data"),{},t),...s},n=Object.fromEntries(Object.keys(o).map(e=>[e,new Set])),a=new Proxy(o,{get(t,s){return s in n&&e&&n[s].add(e),t[s]},set(t,s,o){t[s]=o,s in n||(n[s]=new Set);const i=e;return e=null,n[s].forEach(e=>e()),e=i,!0}});t.nmProxy=a}),n(c,"[nm-ref]").forEach(e=>{const t=a(e),n=e.getAttribute("nm-ref");t.$refs[n]=e}),n(c,"nm-bind").forEach(e=>{const n=a(e),s=i(el.getAttribute(attr),n,el);Object.entries(s).forEach(([s,o])=>{if(o in n||(o=o.bind(e)),s.startsWith("on")){const[a,...n]=s.slice(2).split("."),r=n.find(e=>e.startsWith("debounce")),i=+r?.slice(8),c=s=>{const a=()=>{t=e,o(s),t=null};n.includes("prevent")&&s.preventDefault(),n.includes("stop")&&s.stopPropagation(),i?(clearTimeout(e.nmTimer),e.nmTimer=setTimeout(a,i)):a()};e.addEventListener(a,c,{once:n.includes("once")})}else t=e,r(async()=>{const t=await o(),[n,i]=s.split(".");i?n==="class"?e.classList.toggle(i,t):e[n][i]=t:e[n]=t}),t=null}),o(el,"init",{},!1)})};document.addEventListener("DOMContentLoaded",()=>c(document.body))})()